name: Cross-Compile Windows on Arch and Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  workflow_call:

jobs:
  cross-compile-windows:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cross-compile in Arch container
        uses: addnab/docker-run-action@v3
        with:
          image: archlinux:latest
          options: -v ${{ github.workspace }}:/workspace
          run: |
            set -e
            pacman -Syu --noconfirm
            pacman -S --noconfirm \
              base-devel \
              mingw-w64-gcc \
              mingw-w64-cmake \
              mingw-w64-ninja \
              mingw-w64-lua \
              mingw-w64-luajit \
              mingw-w64-spdlog \
              mingw-w64-boost \
              mingw-w64-nlohmann-json \
              mingw-w64-yaml-cpp \
              mingw-w64-gtest \
              git

            # Install sol2 (header-only)
            git clone --depth 1 --branch v3.3.0 https://github.com/ThePhD/sol2.git /tmp/sol2
            mkdir -p /usr/x86_64-w64-mingw32/include/sol
            cp -r /tmp/sol2/include/sol/* /usr/x86_64-w64-mingw32/include/sol/

            cd /workspace
            mkdir -p build
            cd build
            cmake -G Ninja \
              -DCMAKE_SYSTEM_NAME=Windows \
              -DCMAKE_C_COMPILER=x86_64-w64-mingw32-gcc \
              -DCMAKE_CXX_COMPILER=x86_64-w64-mingw32-g++ \
              -DCMAKE_BUILD_TYPE=Release \
              -DBUILD_TESTS=ON \
              ..
            ninja

            # Package binaries and LICENSE
            mkdir -p /workspace/windows-binaries
            cp instrument-server.exe /workspace/windows-binaries/ || true
            cp instrument-worker.exe /workspace/windows-binaries/ || true
            cp libinstrument-server-core.dll /workspace/windows-binaries/ || true
            cp ../LICENSE /workspace/windows-binaries/
            cp tests/unit_tests.exe /workspace/windows-binaries/ || true
            cp tests/integration_tests.exe /workspace/windows-binaries/ || true
            ls -la /workspace/windows-binaries/

      - name: Upload Windows binaries
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: windows-binaries
          retention-days: 7

  test-on-windows:
    runs-on: windows-latest
    needs: cross-compile-windows
    permissions:
      contents: read
    steps:
      - name: Download Windows binaries
        uses: actions/download-artifact@v4
        with:
          name: windows-binaries
          path: windows-binaries

      - name: Run unit tests
        run: |
          cd windows-binaries
          echo "Running unit tests..."
          if exist unit_tests.exe (
            .\unit_tests.exe
            echo "✓ Unit tests passed successfully"
          ) else (
            echo "No unit_tests.exe found"
          )

      - name: Run integration tests
        run: |
          cd windows-binaries
          echo "Running integration tests..."
          if exist integration_tests.exe (
            .\integration_tests.exe
            echo "✓ Integration tests passed successfully"
          ) else (
            echo "No integration_tests.exe found"
          )

      - name: List packaged files
        run: |
          cd windows-binaries
          dir
