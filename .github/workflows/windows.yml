name: Cross-Compile Windows on Arch and Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      PREBUILT_URL:
        description: "Optional URL to a prebuilt mingw-sysroot tar.gz. If empty, the workflow downloads the mingw-sysroot.tar.gz asset from the release tagged mingw-prebuilt-latest."
        required: false
        default: ""
  workflow_call:

permissions:
  contents: read

jobs:
  cross-build-windows:
    name: Build Windows cross (use prebuilt mingw sysroot)
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: >-
        -v /home/runner/work/instrument-script-server/instrument-script-server:/workspace
    env:
      WORKSPACE: /workspace
      BUILD_DIR: /workspace/build
      PACMAN_CACHE_KEY: pacman-archlinux-v1
      PREBUILT_RELEASE_TAG: mingw-prebuilt-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore pacman cache
        uses: actions/cache@v4
        with:
          path: /var/cache/pacman/pkg
          key: ${{ runner.os }}-${{ env.PACMAN_CACHE_KEY }}
          restore-keys: |
            ${{ runner.os }}-${{ env.PACMAN_CACHE_KEY }}-

      - name: Prepare pacman keys and install host tools
        run: |
          set -euo pipefail
          # fresh gnupg to avoid "no secret key" during pacman operations in new containers
          rm -rf /etc/pacman.d/gnupg || true
          pacman-key --init || true
          pacman-key --populate archlinux

          # Install minimal official packages needed on the host to drive the cross build.
          # The mingw sysroot (headers/libs) will come from the prebuilt tarball.
          pacman -Syu --noconfirm --needed \
            base-devel \
            git \
            mingw-w64-gcc \
            cmake \
            ninja \
            curl \
            jq

      - name: Resolve PREBUILT_URL from release if not provided
        id: resolve_prebuilt
        run: |
          set -euo pipefail
          if [ -n "${{ inputs.PREBUILT_URL }}" ]; then
            echo "prebuilt_url=${{ inputs.PREBUILT_URL }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "No PREBUILT_URL input provided — resolving latest prebuilt release asset from this repository (tag: ${PREBUILT_RELEASE_TAG})..."

          API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${PREBUILT_RELEASE_TAG}"
          AUTH_HEADER="Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}"

          DOWNLOAD_URL=$(curl -sSL -H "Accept: application/vnd.github+json" -H "$AUTH_HEADER" "$API_URL" \
            | jq -r '.assets[] | select(.name=="mingw-sysroot.tar.gz") | .browser_download_url // empty')

          if [ -z "$DOWNLOAD_URL" ]; then
            echo "ERROR: no mingw-sysroot.tar.gz asset found in release ${PREBUILT_RELEASE_TAG}"
            exit 1
          fi

          echo "Resolved PREBUILT_URL: $DOWNLOAD_URL"
          echo "prebuilt_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT

      - name: Download & extract prebuilt mingw sysroot
        run: |
          set -euo pipefail
          PREBUILT_URL="${{ steps.resolve_prebuilt.outputs.prebuilt_url }}"
          if [ -z "$PREBUILT_URL" ]; then
            echo "No PREBUILT_URL resolved; aborting."
            exit 1
          fi
          echo "Downloading prebuilt sysroot from: $PREBUILT_URL"
          # Use GITHUB_TOKEN so private releases are accessible
          curl -fsSL -H "Accept: application/octet-stream" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$PREBUILT_URL" -o /tmp/mingw-sysroot.tar.gz
          echo "Extracting mingw sysroot (tar contains usr/x86_64-w64-mingw32/...)"
          tar -xzf /tmp/mingw-sysroot.tar.gz -C /
          echo "Listing /usr/x86_64-w64-mingw32:"
          ls -la /usr/x86_64-w64-mingw32 || true

      - name: Create builder user and set permissions
        run: |
          set -euo pipefail
          useradd -m -s /bin/bash builder || true
          mkdir -p /home/builder
          chown -R builder:builder /home/builder
          chown -R builder:builder /workspace || true

      - name: Configure & build (cmake + ninja) as builder
        run: |
          set -euo pipefail
          mkdir -p "${BUILD_DIR}"
          cd "${BUILD_DIR}"
          # run the whole build as an unprivileged builder user
          runuser -u builder -- bash -lc '
            set -euo pipefail
            cd /workspace || exit 1
            mkdir -p build
            cd build
            cmake -G Ninja \
              -DCMAKE_SYSTEM_NAME=Windows \
              -DCMAKE_C_COMPILER=x86_64-w64-mingw32-gcc \
              -DCMAKE_CXX_COMPILER=x86_64-w64-mingw32-g++ \
              -DCMAKE_BUILD_TYPE=Release \
              -DBUILD_TESTS=ON \
              ..
            ninja -v
          '

      - name: Collect windows-binaries artifact
        run: |
          set -euo pipefail
          mkdir -p /workspace/windows-binaries
          cd /workspace/build || exit 0
          cp instrument-server.exe /workspace/windows-binaries/ 2>/dev/null || true
          cp instrument-worker.exe /workspace/windows-binaries/ 2>/dev/null || true
          cp libinstrument-server-core.dll /workspace/windows-binaries/ 2>/dev/null || true
          cp ../LICENSE /workspace/windows-binaries/ 2>/dev/null || true
          cp tests/unit_tests.exe /workspace/windows-binaries/ 2>/dev/null || true
          cp tests/integration_tests.exe /workspace/windows-binaries/ 2>/dev/null || true
          ls -la /workspace/windows-binaries || true

      - name: Upload windows binaries artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: /workspace/windows-binaries
          retention-days: 7

  test-on-windows:
    name: Test built Windows artifacts
    runs-on: windows-latest
    needs: cross-build-windows
    permissions:
      contents: read
    steps:
      - name: Download Windows binaries
        uses: actions/download-artifact@v4
        with:
          name: windows-binaries
          path: windows-binaries

      - name: Run unit tests
        run: |
          cd windows-binaries
          echo "Running unit tests..."
          if exist unit_tests.exe (
            .\unit_tests.exe
            echo "✓ Unit tests passed successfully"
          ) else (
            echo "No unit_tests.exe found"
          )

      - name: Run integration tests
        run: |
          cd windows-binaries
          echo "Running integration tests..."
          if exist integration_tests.exe (
            .\integration_tests.exe
            echo "✓ Integration tests passed successfully"
          ) else (
            echo "No integration_tests.exe found"
          )

      - name: List packaged files
        run: |
          cd windows-binaries
          dir
