name: Cross-Compile Windows on Arch and Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      PREBUILT_REF:
        description: "OCI reference for the prebuilt mingw sysroot (e.g., ghcr.io/OWNER/mingw-sysroot:latest). If empty, defaults to ghcr.io/<owner>/mingw-sysroot:latest"
        required: false
        default: ""
  workflow_call:

permissions:
  contents: read
  packages: read

jobs:
  cross-build-windows:
    name: Build Windows cross (use prebuilt mingw sysroot from GHCR)
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: >-
        -v /home/runner/work/instrument-script-server/instrument-script-server:/workspace
    env:
      WORKSPACE: /workspace
      BUILD_DIR: /workspace/build
      PACMAN_CACHE_KEY: pacman-archlinux-v1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore pacman cache
        uses: actions/cache@v4
        with:
          path: /var/cache/pacman/pkg
          key: ${{ runner.os }}-${{ env.PACMAN_CACHE_KEY }}
          restore-keys: |
            ${{ runner.os }}-${{ env.PACMAN_CACHE_KEY }}-

      - name: Prepare pacman keys and install host tools
        run: |
          set -euo pipefail
          rm -rf /etc/pacman.d/gnupg || true
          pacman-key --init || true
          pacman-key --populate archlinux
          pacman -Syu --noconfirm --needed \
            base-devel \
            git \
            mingw-w64-gcc \
            cmake \
            ninja \
            curl \
            jq \
            tar

      - name: Install oras (OCI registry client)
        run: |
          set -euo pipefail
          ORAS_TGZ="/tmp/oras.tar.gz"
          curl -fsSL -o "${ORAS_TGZ}" "https://github.com/oras-project/oras/releases/latest/download/oras_linux_amd64.tar.gz"
          tar -xzf "${ORAS_TGZ}" -C /usr/local/bin oras
          chmod +x /usr/local/bin/oras
          oras version

      - name: Login to GHCR (using GITHUB_TOKEN if needed)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # If the package is public you don't need auth. If it's private or GITHUB_TOKEN is required, login.
          if [ -n "${GITHUB_TOKEN:-}" ]; then
            echo "${GITHUB_TOKEN}" | oras login ghcr.io -u "${GITHUB_ACTOR}" --password-stdin
          else
            echo "No GITHUB_TOKEN available; attempting unauthenticated pull (artifact must be public)."
          fi

      - name: Pull & extract prebuilt mingw sysroot from GHCR
        env:
          PREBUILT_REF_INPUT: ${{ inputs.PREBUILT_REF }}
        run: |
          set -euo pipefail
          if [ -n "${PREBUILT_REF_INPUT}" ]; then
            REF="${PREBUILT_REF_INPUT}"
          else
            REF="ghcr.io/${GITHUB_REPOSITORY_OWNER}/mingw-sysroot:latest"
          fi
          echo "Pulling prebuilt sysroot artifact from: ${REF}"
          mkdir -p /tmp/oras-out
          cd /tmp/oras-out
          oras pull "${REF}"
          TARFILE=$(ls -1 *.tar.gz 2>/dev/null || true)
          if [ -z "${TARFILE}" ]; then
            echo "ERROR: no .tar.gz artifact found after oras pull"
            ls -la /tmp/oras-out || true
            exit 1
          fi
          mv "${TARFILE}" /tmp/mingw-sysroot.tar.gz
          echo "Extracting mingw sysroot (tar contains usr/x86_64-w64-mingw32/...)"
          tar -xzf /tmp/mingw-sysroot.tar.gz -C /
          ls -la /usr/x86_64-w64-mingw32 || true

      - name: Create builder user and set permissions
        run: |
          set -euo pipefail
          useradd -m -s /bin/bash builder || true
          mkdir -p /home/builder
          chown -R builder:builder /home/builder
          chown -R builder:builder /workspace || true

      - name: Configure & build (cmake + ninja) as builder
        run: |
          set -euo pipefail
          mkdir -p "${BUILD_DIR}"
          cd "${BUILD_DIR}"
          runuser -u builder -- bash -lc '
            set -euo pipefail
            cd /workspace || exit 1
            mkdir -p build
            cd build
            cmake -G Ninja \
              -DCMAKE_SYSTEM_NAME=Windows \
              -DCMAKE_C_COMPILER=x86_64-w64-mingw32-gcc \
              -DCMAKE_CXX_COMPILER=x86_64-w64-mingw32-g++ \
              -DCMAKE_BUILD_TYPE=Release \
              -DBUILD_TESTS=ON \
              ..
            ninja -v
          '

      - name: Collect windows-binaries artifact
        run: |
          set -euo pipefail
          mkdir -p /workspace/windows-binaries
          cd /workspace/build || exit 0
          cp instrument-server.exe /workspace/windows-binaries/ 2>/dev/null || true
          cp instrument-worker.exe /workspace/windows-binaries/ 2>/dev/null || true
          cp libinstrument-server-core.dll /workspace/windows-binaries/ 2>/dev/null || true
          cp ../LICENSE /workspace/windows-binaries/ 2>/dev/null || true
          cp tests/unit_tests.exe /workspace/windows-binaries/ 2>/dev/null || true
          cp tests/integration_tests.exe /workspace/windows-binaries/ 2>/dev/null || true
          ls -la /workspace/windows-binaries || true

      - name: Upload windows binaries artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: /workspace/windows-binaries
          retention-days: 7

  test-on-windows:
    name: Test built Windows artifacts
    runs-on: windows-latest
    needs: cross-build-windows
    permissions:
      contents: read
    steps:
      - name: Download Windows binaries
        uses: actions/download-artifact@v4
        with:
          name: windows-binaries
          path: windows-binaries

      - name: Run unit tests (cmd)
        shell: cmd
        run: |
          cd windows-binaries
          echo Running unit tests...
          if exist unit_tests.exe (
            .\unit_tests.exe
            echo ✓ Unit tests passed successfully
          ) else (
            echo No unit_tests.exe found
          )

      - name: Run integration tests (cmd)
        shell: cmd
        run: |
          cd windows-binaries
          echo Running integration tests...
          if exist integration_tests.exe (
            .\integration_tests.exe
            echo ✓ Integration tests passed successfully
          ) else (
            echo No integration_tests.exe found
          )

      - name: List packaged files
        shell: cmd
        run: |
          cd windows-binaries
          dir
