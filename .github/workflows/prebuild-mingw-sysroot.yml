name: Prebuild â€” mingw sysroot (create prebuilt tarball & push to GHCR with oras)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 0" # weekly (UTC)

permissions:
  contents: read
  packages: write

jobs:
  prebuild-mingw-sysroot:
    name: Build mingw sysroot and upload to GHCR
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: >-
        -v /home/runner/work/instrument-script-server/instrument-script-server:/workspace
    env:
      SYSROOT_TARBALL_PATH: /tmp/mingw-sysroot.tar.gz
      WORKSPACE: /workspace
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore pacman cache
        uses: actions/cache@v4
        with:
          path: /var/cache/pacman/pkg
          key: ${{ runner.os }}-pacman-cache-v1

      - name: Prepare pacman keys and install base packages
        run: |
          set -euo pipefail
          rm -rf /etc/pacman.d/gnupg || true
          pacman-key --init || true
          pacman-key --populate archlinux
          # Install minimal host packages and common build deps
          pacman -Syu --noconfirm --needed base-devel git mingw-w64-gcc cmake ninja curl jq go sudo tar

      - name: Create builder user
        run: |
          set -euo pipefail
          useradd -m -s /bin/bash builder || true
          mkdir -p /home/builder
          chown -R builder:builder /home/builder
          chown -R builder:builder /workspace || true

      - name: Create safe sudoers for builder
        run: |
          set -euo pipefail
          rm -f /etc/sudoers.d/builder
          cat <<'EOF' >/etc/sudoers.d/builder
builder ALL=(ALL) NOPASSWD: /usr/bin/pacman
EOF
          chmod 0440 /etc/sudoers.d/builder
          # Validate syntax; this will fail the job if the file is invalid
          visudo -cf /etc/sudoers.d/builder

      - name: Build yay and install AUR mingw packages as builder
        run: |
          set -euo pipefail
          runuser -u builder -- bash -lc '
            set -euo pipefail
            cd "$HOME"
            if [ ! -d "$HOME/yay" ]; then
              git clone https://aur.archlinux.org/yay.git
            fi
            cd yay
            makepkg -si --noconfirm
            AUR_PKGS=(
              mingw-w64-cmake
              mingw-w64-lua
              mingw-w64-luajit
              mingw-w64-spdlog
              mingw-w64-boost
              mingw-w64-nlohmann-json
              mingw-w64-yaml-cpp
              mingw-w64-gtest
            )
            for p in "${AUR_PKGS[@]}"; do
              echo "Installing AUR pkg: $p"
              yay -S --noconfirm --mflags --skipinteg "$p"
            done
          '

      - name: Ensure sol2 headers (header-only)
        run: |
          set -euo pipefail
          git clone --depth 1 --branch v3.3.0 https://github.com/ThePhD/sol2.git /tmp/sol2 || true
          mkdir -p /usr/x86_64-w64-mingw32/include/sol
          cp -r /tmp/sol2/include/sol/* /usr/x86_64-w64-mingw32/include/sol/ || true
          chown -R root:root /usr/x86_64-w64-mingw32/include/sol || true

      - name: Create tarball of mingw sysroot
        run: |
          set -euo pipefail
          if [ ! -d /usr/x86_64-w64-mingw32 ]; then
            echo "ERROR: expected /usr/x86_64-w64-mingw32 to exist but it does not"
            ls -la /usr || true
            exit 1
          fi
          tar -C / -czf "${SYSROOT_TARBALL_PATH}" usr/x86_64-w64-mingw32
          echo "Tarball size:"
          ls -lh "${SYSROOT_TARBALL_PATH}"
          echo "Tarball contents preview:"
          tar -tf "${SYSROOT_TARBALL_PATH}" | head -n 50

      - name: Upload tarball as workflow artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: mingw-sysroot-tarball
          path: /tmp/mingw-sysroot.tar.gz

      - name: Install oras (OCI registry client)
        run: |
          set -euo pipefail
          ORAS_TGZ="/tmp/oras.tar.gz"
          curl -fsSL -o "${ORAS_TGZ}" "https://github.com/oras-project/oras/releases/latest/download/oras_linux_amd64.tar.gz"
          tar -xzf "${ORAS_TGZ}" -C /usr/local/bin oras
          chmod +x /usr/local/bin/oras
          oras version

      - name: Login to GHCR (using GITHUB_TOKEN)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${GITHUB_TOKEN:-}" ]; then
            echo "GITHUB_TOKEN not available; ensure workflow permissions allow packages: write"
            exit 1
          fi
          echo "${GITHUB_TOKEN}" | oras login ghcr.io -u "${GITHUB_ACTOR}" --password-stdin

      - name: Push mingw sysroot to GHCR (versioned + latest)
        id: push_oras
        run: |
          set -euo pipefail
          REGISTRY="ghcr.io"
          REPO="${{ github.repository_owner }}/mingw-sysroot"
          VERSION_TAG="run-${GITHUB_RUN_ID}"
          VERSION_REF="${REGISTRY}/${REPO}:${VERSION_TAG}"
          LATEST_REF="${REGISTRY}/${REPO}:latest"
          echo "Pushing versioned artifact ${VERSION_REF}"
          oras push "${VERSION_REF}" /tmp/mingw-sysroot.tar.gz --artifact-type application/vnd.tar+gzip
          echo "Pushing latest artifact ${LATEST_REF}"
          oras push "${LATEST_REF}" /tmp/mingw-sysroot.tar.gz --artifact-type application/vnd.tar+gzip
          echo "version_ref=${VERSION_REF}" >> $GITHUB_OUTPUT
          echo "latest_ref=${LATEST_REF}" >> $GITHUB_OUTPUT

      - name: Done (print refs)
        run: |
          echo "Uploaded OCI artifact refs:"
          echo "version_ref = ${{ steps.push_oras.outputs.version_ref }}"
          echo "latest_ref  = ${{ steps.push_oras.outputs.latest_ref }}"
