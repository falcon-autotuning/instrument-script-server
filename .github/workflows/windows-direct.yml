name: Native Windows Build and Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read

jobs:
  build-and-test-windows:
    name: Build and Test on Windows (vcpkg + clang-cl)
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install LLVM (clang/clang-cl) via Chocolatey
        # This installs LLVM into "C:\Program Files\LLVM" and adds it to PATH for the job
        run: |
          choco install llvm -y --no-progress
          RefreshEnv
        shell: pwsh

      - name: Show clang versions (verify installation)
        run: |
          & "C:\Program Files\LLVM\bin\clang" --version || clang --version
          & "C:\Program Files\LLVM\bin\clang-cl" --version || clang-cl --version
        shell: pwsh

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: "73af4de996897cb45dcf5034d16a551a3cf476f7"

      - name: Install dependencies via vcpkg (manifest or explicit)
        # If you use vcpkg.json manifest keep this step simple (manifest mode)
        run: |
          # manifest mode (recommended) -- installs packages for x64-windows
          vcpkg install --triplet x64-windows
        shell: pwsh

      - name: Configure CMake with clang-cl (Visual Studio generator)
        run: |
          cmake -B build `
            -S . `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -T ClangCL `
            -DCMAKE_C_COMPILER="C:/Program Files/LLVM/bin/clang-cl.exe" `
            -DCMAKE_CXX_COMPILER="C:/Program Files/LLVM/bin/clang-cl.exe" `
            -DCMAKE_TOOLCHAIN_FILE="${env:VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_TESTS=ON
        shell: pwsh

      - name: Build project (MSBuild via CMake)
        run: |
          cmake --build build --config Release --verbose
        shell: pwsh

      - name: List test executables (debug)
        run: |
          Write-Host "=== Listing test directory contents ==="
          if (Test-Path "build/tests") {
            Get-ChildItem -Path "build/tests" -Recurse -Include *.exe | ForEach-Object { Write-Host $_.FullName }
          } else {
            Write-Host "build/tests directory does not exist"
          }
        shell: pwsh

      - name: Run unit tests
        run: |
          # Visual Studio generator puts executables in Release/ subdirectory
          $testPath = "build/tests/Release/unit_tests.exe"
          if (Test-Path $testPath) {
            Write-Host "Running unit tests from: $testPath"
            & $testPath
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Unit tests failed with exit code $LASTEXITCODE"
              exit $LASTEXITCODE
            }
            Write-Host "✓ Unit tests passed successfully"
          } else {
            Write-Host "ERROR: unit_tests.exe not found at: $testPath"
            Write-Host "Directory contents:"
            Get-ChildItem -Path "build/tests" -Recurse
            exit 1
          }
        shell: pwsh

      - name: Run integration tests
        run: |
          # Visual Studio generator puts executables in Release/ subdirectory
          $testPath = "build/tests/Release/integration_tests.exe"
          if (Test-Path $testPath) {
            Write-Host "Running integration tests from: $testPath"
            & $testPath
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Integration tests failed with exit code $LASTEXITCODE"
              exit $LASTEXITCODE
            }
            Write-Host "✓ Integration tests passed successfully"
          } else {
            Write-Host "ERROR:  integration_tests.exe not found at: $testPath"
            Write-Host "Directory contents:"
            Get-ChildItem -Path "build/tests" -Recurse
            exit 1
          }
        shell: pwsh

      - name: Collect artifacts
        run: |
          New-Item -ItemType Directory -Force -Path windows-binaries
          Copy-Item -Path "LICENSE" -Destination "windows-binaries/" -ErrorAction SilentlyContinue
          Get-ChildItem -Path "build" -Recurse -Include *.exe,*.dll | Copy-Item -Destination "windows-binaries/" -ErrorAction SilentlyContinue
          Get-ChildItem -Path "windows-binaries"
        shell: pwsh

      - name: Upload Windows binaries
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: windows-binaries/
          retention-days: 7

      - name: Setup tmate session for debugging (on failure)
        if: ${{ failure() }}
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 30
        with:
          limit-access-to-actor: true
